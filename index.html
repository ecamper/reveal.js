<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Kasper Saga</title>

		<meta name="description" content="Saga on Viadeo Kasper Framework">
		<meta name="author" content="Emmanuel Camper">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/moon.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Saga</h1>
					<h3>On Kasper Framework</h3>
					<p>
						<small>Inspired from <a href="http://www.axonframework.org/docs/2.0/sagas.html">Axon Saga</a></small>
					</p>
				</section>

				<section>
					<h2>What is a Saga for ?</h2>
					<p>
						For managing complex business transactions
						Examples : 
						<ul>
							<li>Send reconnection mails</li>
							<li>Post company status in the Future</li>
							<li>Manage money transactions</li>
						</ul>
					</p>
				</section>

				<section>
					<h2>What is a Saga ?</h2>
					<p>
						A Special <strong>Event Listener</strong> managing a single Business Transaction
						<ul>
							<li>Responds on Event produced by commands</li>
							<li>May produce new commands</li>
							<li>May invoke external applications</li>
							<li>etc.</li>
						</ul>
					</p>
				</section>

				<section>
					<h2>Life Cycle</h2>
					<p>
						Must be annotated by <em><strong>@XKasperSaga</strong></em>
					</p>
					<p class="fragment">
						Must implement <strong>Saga</strong> interface
					</p>
					<p class="fragment">
						Has <strong>Start</strong> and one or many <strong>End</strong>
					</p>
					<p class="fragment">
						Can have several steps triggered by Events
					</p>
					<p class="fragment">
						Can trigger scheduled methods
					</p>
					<p class="fragment">
						Only one <strong>active</strong> Saga for one identifier
					</p>
				</section>

				<section>
					<h2>Annotations in Platform</h2>
					<ul>
						<li>@XKasperSaga.Start(getter = "getEntityId")</li>
						<li>@XKasperSaga.Step(getter = "getEntityId")</li>
						<li>@XKasperSaga.Schedule(delay = 1, unit = TimeUnit.MINUTES, methodName = "sayCoucou")</li>
						<li>@XKasperSaga.ScheduledByEvent(methodName = "createNewsProgrammed")</li>
						<li>@XKasperSaga.End(getter = "getEntityId")</li>
					</ul>
				</section>

				<section>
					<h2>Identifier Management</h2>
					<p>Override getIdReconciler</p>
					<pre><code class="java">
@Override
public SagaIdReconciler getIdReconciler() {
    return new SagaIdReconciler() {
        @Override
        public Object reconcile(Object identifier) {
            if (identifier instanceof Integer) {
                return ViadeoIDs.newMemberID((Integer) identifier);
            } else if (identifier instanceof ID) {
                return idTransformer.to(Formats.DB_ID, (ID) identifier);
            } else {
                return identifier;
            }
        }
    });
}
					</code></pre>
				</section>

				<section>
					<h2>Example of use</h2>
					<pre><code class="java">
@XKasperSaga(domain = HelloDomain.class, description = "hello saga" )
public class HelloSaga implements Saga {

    private static final Logger LOGGER = getLogger(HelloSaga.class);
    private KasperID id;

    @Override
    public Optional SagaIdReconciler getIdReconciler() {
        return Optional.absent();
    }

	@XKasperSaga.Start(getter = "getEntityId")
    public void start(final HelloCreatedEvent event){
        this.id = event.getEntityId();
        LOGGER.info("A Hello saga has started : "+event.getEntityId());
    }

    @XKasperSaga.Step(getter = "getEntityId")
    @XKasperSaga.Schedule(delay = 1, unit = TimeUnit.MINUTES, methodName = "sayCoucou")
    public void stepHelloBuddyChanged(final BuddyChangedForHelloMessageEvent event){
        LOGGER.info("A Hello step has been triggers : "+event.getEntityId());
    }

    @XKasperSaga.End(getter = "getEntityId")
    public void end(final HelloDeletedEvent event){
        LOGGER.info("A Hello saga has ended : "+event.getEntityId());
    }

    private void sayCoucou(){
        LOGGER.info("A Hello schedule method call has been triggered by scheduler : " + this.id);
    }
}
					</code></pre>
				</section>

				<section>
					<h2>Scheduled By Event (1/2)</h2>
					<pre><code class="java">
@XKasperSaga.Start(getter = "getEntityId")
@XKasperSaga.ScheduledByEvent(methodName = "createNewsProgrammed")
public void start(final NewsProgrammedEvent newsProgrammedEvent) {
    LOGGER.info("Programmed news saga started for news [" + newsProgrammedEvent.getEntityId() + "]");
    this.news = newsProgrammedEvent.getNews();
    this.producerId = newsProgrammedEvent.getProducerId();
    this.newsId = newsProgrammedEvent.getEntityId();
}
					</code></pre>

				</section>
				<section>
					<h2>Scheduled By Event (2/2)</h2>
					<p>Event must : 
						<ul>
						<li>implements interface <strong>SchedulableSagaMethod</strong></li>
						<li>overrides method <strong>getScheduledDate</strong></li>
						<pre><code class="java">
    @Override
    public DateTime getScheduledDate() {
        return this.getNews().getPublished();
    }
					</code></pre>
				</ul>
					</p>
				</section>

				<section>
					<h2>Injecting Resources</h2>
					<p>
						By constructor
						<pre><code class="java">
@XKasperSaga(description = "create news in the future", domain = NewsfeedDomain.class)
public class NewsProgrammedSaga implements Saga {

    private static final Logger LOGGER = LoggerFactory.getLogger(NewsProgrammedSaga.class);

    private CommandGateway commandGateway;
    private IDTransformer idTransformer;

    @Inject
    public NewsProgrammedSaga(final CommandGateway commandGateway, final IDTransformer idTransformer) {
        this.commandGateway = checkNotNull(commandGateway);
        this.idTransformer = checkNotNull(idTransformer);
    }
}
						</code></pre>
					</p>
				</section>

				<section>
					<h2>Saga Repository</h2>
					<p>
						Default implementation in Memory
					</p>
					<p class="fragment">
						Platform impl in DynamoDB
					</p>
					<p class="fragment">
						One table for all Sagas (R/W Throughput must be adjusted)
					</p>
				</section>

				<section style="text-align: left;">
					<h1>THE END</h1>
					<p>
						- <a href="http://www.axonframework.org/docs/2.0/sagas.html">Axonframework Saga</a> <br>
						- <a href="http://doc01.infra.paris.apvo/kasper-framework/1.0.1/develop/guide/2_defining_a_domain/5_defining_an_event_system.html#defining-a-saga">Kasper saga Doc</a>
					</p>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
